# 代码审查指南

## 📋 目录

- [概述](#概述)
- [审查流程](#审查流程)
- [审查清单](#审查清单)
- [审查标准](#审查标准)
- [常见问题](#常见问题)
- [工具和资源](#工具和资源)

---

## 概述

代码审查是确保代码质量、知识共享和团队协作的重要环节。本文档定义了MallEcoAPI项目的代码审查规范和流程。

### 审查目标

1. **代码质量**: 确保代码符合项目规范和最佳实践
2. **功能正确性**: 验证功能实现是否正确
3. **性能优化**: 识别性能问题和优化机会
4. **安全性**: 检查安全漏洞和风险
5. **可维护性**: 确保代码易于理解和维护
6. **知识共享**: 通过审查促进团队学习

---

## 审查流程

### 1. 提交前检查

在提交PR之前，开发者应该：

```bash
# 1. 运行测试
npm test

# 2. 检查代码覆盖率
npm run test:cov

# 3. 运行Lint检查
npm run lint

# 4. 格式化代码
npm run format

# 5. 类型检查
npm run type-check
```

### 2. 创建Pull Request

**PR标题格式**:
```
type(scope): description

例如:
feat(orders): 添加订单自动取消功能
fix(auth): 修复JWT token过期问题
refactor(cache): 优化缓存策略
```

**PR描述模板**:
```markdown
## 变更说明
- 描述本次变更的主要内容

## 相关Issue
- Fixes #123

## 测试
- [ ] 单元测试已添加/更新
- [ ] 集成测试已通过
- [ ] 手动测试已完成

## 检查清单
- [ ] 代码已通过Lint检查
- [ ] 代码已格式化
- [ ] 类型检查已通过
- [ ] 文档已更新（如需要）
- [ ] 无控制台日志或调试代码
```

### 3. 审查流程

```
开发者提交PR
    ↓
自动检查（CI/CD）
    ↓
分配审查者（至少1人）
    ↓
审查者审查代码
    ↓
[有问题] → 提出修改建议 → 开发者修改 → 重新审查
    ↓
[无问题] → 批准合并
```

### 4. 审查时间要求

- **紧急修复**: 4小时内完成审查
- **常规功能**: 24小时内完成审查
- **大型重构**: 48小时内完成审查

---

## 审查清单

### 代码规范

- [ ] **命名规范**
  - 文件名使用kebab-case
  - 类名使用PascalCase
  - 函数/变量使用camelCase
  - 常量使用UPPER_SNAKE_CASE

- [ ] **代码格式**
  - 使用Prettier格式化
  - 遵循ESLint规则
  - 无未使用的导入
  - 无未使用的变量

- [ ] **TypeScript规范**
  - 避免使用`any`类型
  - 使用接口定义数据结构
  - 使用枚举定义常量
  - 类型定义完整

### 功能实现

- [ ] **业务逻辑**
  - 功能实现正确
  - 边界条件处理
  - 错误处理完善
  - 输入验证完整

- [ ] **API设计**
  - RESTful规范
  - 请求/响应格式统一
  - 错误码规范
  - Swagger文档完整

- [ ] **数据库操作**
  - 查询优化（避免N+1）
  - 事务处理正确
  - 索引使用合理
  - 数据验证完整

### 性能和安全

- [ ] **性能优化**
  - 无性能瓶颈
  - 缓存使用合理
  - 数据库查询优化
  - 异步处理正确

- [ ] **安全性**
  - 输入验证和清理
  - SQL注入防护
  - XSS防护
  - 认证授权正确
  - 敏感信息保护

### 测试和文档

- [ ] **测试覆盖**
  - 单元测试完整
  - 集成测试覆盖
  - 测试用例有意义
  - 测试通过率>70%

- [ ] **文档**
  - 代码注释清晰
  - API文档完整
  - 变更日志更新
  - README更新（如需要）

### 代码质量

- [ ] **可读性**
  - 代码结构清晰
  - 函数职责单一
  - 命名有意义
  - 注释适当

- [ ] **可维护性**
  - 无重复代码
  - 模块化设计
  - 依赖关系清晰
  - 易于扩展

---

## 审查标准

### 必须修改（Blocking）

以下问题必须修复才能合并：

1. **安全漏洞**: SQL注入、XSS、认证绕过等
2. **功能错误**: 业务逻辑错误、数据不一致
3. **性能问题**: 明显的性能瓶颈、内存泄漏
4. **测试失败**: 单元测试或集成测试失败
5. **构建失败**: 编译错误、类型错误

### 建议修改（Non-blocking）

以下问题建议修复，但不阻止合并：

1. **代码风格**: 命名不规范、格式不统一
2. **代码优化**: 可以优化的地方
3. **文档完善**: 缺少注释或文档
4. **测试补充**: 测试覆盖率不足

### 审查意见类型

- **必须修改（Must Fix）**: 🔴 必须修复才能合并
- **建议修改（Should Fix）**: 🟡 建议修复，但不阻止合并
- **可选优化（Nice to Have）**: 🟢 可选优化，不影响功能
- **问题（Question）**: ❓ 需要澄清的问题
- **表扬（Praise）**: 👍 做得好的地方

---

## 常见问题

### 1. 如何处理审查意见？

**开发者应该**:
- 认真对待所有审查意见
- 对于必须修改的问题，立即修复
- 对于建议修改的问题，评估后决定是否修复
- 如有疑问，主动与审查者沟通
- 修复后及时回复审查者

**审查者应该**:
- 提供清晰的修改建议
- 解释为什么需要修改
- 提供代码示例（如需要）
- 及时响应开发者的疑问

### 2. 如何处理意见分歧？

1. **讨论**: 在PR中讨论，说明各自观点
2. **参考文档**: 查阅项目规范和最佳实践
3. **团队决策**: 如无法达成一致，提交团队讨论
4. **技术负责人**: 最终由技术负责人决定

### 3. 如何提高审查效率？

**审查者**:
- 及时响应PR
- 提供具体的修改建议
- 使用审查工具（如GitHub Review）
- 关注重点问题

**开发者**:
- 提交前自行检查
- 编写清晰的PR描述
- 小步提交，避免大PR
- 及时响应审查意见

---

## 工具和资源

### 自动化工具

1. **ESLint**: 代码质量检查
2. **Prettier**: 代码格式化
3. **Jest**: 测试运行和覆盖率
4. **Husky**: Git hooks
5. **lint-staged**: 暂存文件检查

### 审查工具

1. **GitHub Pull Requests**: PR审查
2. **Code Review Checklist**: 审查清单
3. **SonarQube**: 代码质量分析（可选）

### 参考资源

- [NestJS最佳实践](https://docs.nestjs.com/)
- [TypeScript编码规范](https://www.typescriptlang.org/docs/handbook/declaration-files/do-s-and-don-ts.html)
- [Node.js安全最佳实践](https://nodejs.org/en/docs/guides/security/)

---

## PR模板

创建 `.github/pull_request_template.md`:

```markdown
## 变更说明
<!-- 描述本次变更的主要内容 -->

## 变更类型
- [ ] 新功能 (feature)
- [ ] Bug修复 (fix)
- [ ] 代码重构 (refactor)
- [ ] 文档更新 (docs)
- [ ] 性能优化 (perf)
- [ ] 测试相关 (test)
- [ ] 构建/工具 (chore)

## 相关Issue
<!-- 关联的Issue编号 -->
Fixes #

## 测试
- [ ] 单元测试已添加/更新
- [ ] 集成测试已通过
- [ ] 手动测试已完成
- [ ] 测试覆盖率>70%

## 检查清单
- [ ] 代码已通过Lint检查 (`npm run lint`)
- [ ] 代码已格式化 (`npm run format`)
- [ ] 类型检查已通过 (`npm run type-check`)
- [ ] 所有测试已通过 (`npm test`)
- [ ] 文档已更新（如需要）
- [ ] 无控制台日志或调试代码
- [ ] 无硬编码的敏感信息
- [ ] API文档已更新（Swagger）

## 截图/演示
<!-- 如适用，提供截图或演示 -->

## 其他说明
<!-- 其他需要说明的内容 -->
```

---

## 审查最佳实践

### 对审查者

1. **及时响应**: 尽快开始审查，避免阻塞开发者
2. **建设性反馈**: 提供具体的、可操作的反馈
3. **平衡严格和友好**: 严格但不失友好
4. **关注重点**: 优先关注功能正确性和安全性
5. **表扬好的代码**: 认可做得好的地方

### 对开发者

1. **小步提交**: 避免大PR，便于审查
2. **清晰描述**: 提供清晰的PR描述
3. **自行检查**: 提交前自行检查代码
4. **及时响应**: 及时响应审查意见
5. **保持开放**: 接受建设性批评

---

**最后更新**: 2024-12-19

