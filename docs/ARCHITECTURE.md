# MallEcoAPI 架构文档

## 📋 目录

- [系统架构概述](#系统架构概述)
- [技术架构](#技术架构)
- [模块架构](#模块架构)
- [数据架构](#数据架构)
- [安全架构](#安全架构)
- [性能架构](#性能架构)
- [部署架构](#部署架构)

---

## 系统架构概述

MallEcoAPI 是一个基于 NestJS 的企业级商城系统后端API，采用模块化设计，支持微服务架构扩展。

### 架构特点

- **模块化设计**: 业务模块独立，低耦合高内聚
- **分层架构**: Controller → Service → Repository 清晰分层
- **AOP支持**: 防重复提交、限流等横切关注点
- **事件驱动**: 支持事件发布和订阅，解耦业务逻辑
- **缓存策略**: 多级缓存，防止穿透和雪崩
- **监控完善**: 性能监控、日志记录、健康检查

---

## 技术架构

### 技术栈

```
┌─────────────────────────────────────────┐
│         NestJS Framework                │
│  (TypeScript + Express + Decorators)    │
└─────────────────────────────────────────┘
                    │
    ┌───────────────┼───────────────┐
    │               │               │
┌───▼───┐    ┌─────▼─────┐   ┌────▼─────┐
│MySQL  │    │  Redis    │   │ RabbitMQ │
│TypeORM│    │  Cache    │   │   MQ     │
└───────┘    └───────────┘   └──────────┘
```

### 核心依赖

- **NestJS 11.x**: 核心框架
- **TypeORM 0.3.x**: ORM框架
- **Passport + JWT**: 认证授权
- **Swagger**: API文档
- **@nestjs/throttler**: 限流
- **@nestjs/cache-manager**: 缓存管理
- **@nestjs/event-emitter**: 事件系统

---

## 模块架构

### 模块分层

```
┌─────────────────────────────────────┐
│         Presentation Layer          │
│  (Controllers + DTOs + Swagger)     │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│          Business Layer            │
│      (Services + Logic)           │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│         Data Access Layer          │
│    (Repositories + Entities)       │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│      Infrastructure Layer          │
│  (Cache + Database + Monitoring)   │
└─────────────────────────────────────┘
```

### 核心模块

#### 1. 业务模块 (modules/)

```
modules/
├── auth/              # 认证授权
│   ├── controllers/
│   ├── services/
│   ├── guards/
│   └── strategies/
├── users/             # 用户管理
├── goods/             # 商品管理
├── orders/            # 订单管理
├── payment/           # 支付管理
├── promotion/         # 促销管理
├── im/                # 即时通讯
└── ...
```

#### 2. 共享模块 (shared/)

```
shared/
├── aop/               # AOP模块
│   ├── decorators/   # 装饰器
│   └── interceptors/  # 拦截器
├── decorators/        # 通用装饰器
├── filters/           # 异常过滤器
├── guards/            # 守卫
├── interceptors/      # 拦截器
├── utils/             # 工具类
└── events/            # 事件系统
```

#### 3. 基础设施 (infrastructure/)

```
infrastructure/
├── cache/             # 缓存服务
│   ├── cache-protection.service.ts
│   └── cache-warmup.service.ts
├── database/          # 数据库服务
└── monitoring/        # 监控服务
    ├── database-query-optimizer.service.ts
    ├── query-performance.service.ts
    └── cache-monitor.service.ts
```

---

## 数据架构

### 数据库设计

**主数据库**: MySQL 8.0+

**设计原则**:
- 规范化设计，减少冗余
- 合理使用索引
- 分表策略（按需）
- 读写分离（可选）

### 缓存架构

**缓存策略**:
```
┌─────────────┐
│  应用层     │
└──────┬──────┘
       │
┌──────▼──────┐      ┌──────────┐
│ 本地缓存    │─────▶│  Redis   │
│ (内存)      │      │ (分布式) │
└─────────────┘      └──────────┘
```

**缓存层级**:
1. **L1**: 应用内存缓存（热点数据）
2. **L2**: Redis分布式缓存
3. **L3**: 数据库

**缓存保护**:
- 防止缓存穿透（空值缓存）
- 防止缓存雪崩（随机TTL）
- 缓存预热机制

---

## 安全架构

### 认证授权

```
┌─────────────┐
│  客户端     │
└──────┬──────┘
       │ 1. 登录请求
       ▼
┌─────────────┐
│  Auth模块   │───▶ JWT Token
└──────┬──────┘
       │ 2. 返回Token
       ▼
┌─────────────┐
│  业务API    │
│  JWT Guard  │───▶ 验证Token
└─────────────┘
```

### 安全措施

1. **JWT认证**
   - Token过期机制
   - Refresh Token支持
   - Token黑名单（可选）

2. **API限流**
   - 全局限流（@nestjs/throttler）
   - 路由级限流
   - IP级限流

3. **防重复提交**
   - 基于缓存的防重复提交
   - 用户隔离支持

4. **数据加密**
   - 密码BCrypt加密
   - 敏感数据加密存储

---

## 性能架构

### 性能优化策略

#### 1. 数据库优化

- **索引优化**: 为常用查询字段添加索引
- **查询优化**: 避免N+1查询，使用JOIN
- **连接池**: 合理配置连接池大小
- **慢查询监控**: 自动识别和优化慢查询

#### 2. 缓存优化

- **多级缓存**: 本地缓存 + Redis
- **缓存预热**: 启动时预加载热点数据
- **缓存监控**: 监控命中率和性能

#### 3. API优化

- **响应压缩**: Gzip压缩
- **异步处理**: 耗时操作异步化
- **批量操作**: 支持批量查询和更新

### 性能监控

```
┌─────────────┐
│  应用监控   │
│  Performance│
└──────┬──────┘
       │
┌──────▼──────┐
│ Prometheus  │
│   Metrics   │
└──────┬──────┘
       │
┌──────▼──────┐
│  Grafana    │
│  Dashboard  │
└─────────────┘
```

---

## 部署架构

### 单机部署

```
┌─────────────────┐
│   Nginx         │
│  (反向代理)     │
└────────┬────────┘
         │
┌────────▼────────┐
│  MallEcoAPI     │
│  (NestJS App)   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼───┐
│ MySQL │ │Redis │
└───────┘ └──────┘
```

### 微服务部署（可选）

```
┌─────────────┐
│   API网关   │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
┌──▼──┐ ┌──▼──┐
│服务1│ │服务2│
└─────┘ └─────┘
```

### Docker部署

```yaml
services:
  api:
    image: malleco-api:latest
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
```

---

## 数据流图

### 请求处理流程

```
客户端请求
    │
    ▼
┌─────────────┐
│  中间件     │ (CORS, Body Parser)
└──────┬──────┘
       │
    ┌──▼──┐
    │限流 │ (Throttler)
    └──┬──┘
       │
    ┌──▼──┐
    │认证 │ (JWT Guard)
    └──┬──┘
       │
    ┌──▼──┐
    │拦截器│ (Performance, Response)
    └──┬──┘
       │
    ┌──▼──┐
    │控制器│ (Controller)
    └──┬──┘
       │
    ┌──▼──┐
    │服务层│ (Service)
    └──┬──┘
       │
    ┌──▼──┐
    │缓存 │ (Cache)
    └──┬──┘
       │
    ┌──▼──┐
    │数据库│ (Database)
    └──────┘
```

### 事件处理流程

```
业务操作
    │
    ▼
┌─────────────┐
│  服务层     │
└──────┬──────┘
       │
    ┌──▼──┐
    │发布事件│ (EventPublisher)
    └──┬──┘
       │
    ┌──▼──┐
    │事件总线│ (EventEmitter)
    └──┬──┘
       │
    ┌──▼──┐
    │监听器│ (Event Listeners)
    └──────┘
```

---

## 扩展性设计

### 水平扩展

- **无状态设计**: 应用无状态，支持多实例
- **共享缓存**: Redis作为共享缓存
- **负载均衡**: Nginx或云负载均衡器

### 垂直扩展

- **数据库优化**: 索引、分区、读写分离
- **缓存优化**: 多级缓存、预热
- **代码优化**: 异步处理、批量操作

---

## 监控与运维

### 监控指标

- **应用指标**: CPU、内存、请求数、响应时间
- **业务指标**: 订单数、用户数、交易额
- **数据库指标**: 连接数、慢查询、QPS
- **缓存指标**: 命中率、内存使用

### 日志管理

- **结构化日志**: Winston日志框架
- **日志级别**: Error、Warn、Info、Debug
- **日志存储**: 文件 + Elasticsearch（可选）

### 健康检查

- **应用健康**: `/health`
- **数据库健康**: 连接检查
- **缓存健康**: Redis连接检查

---

## 技术选型说明

### 为什么选择NestJS？

1. **TypeScript原生支持**: 类型安全
2. **模块化设计**: 易于维护和扩展
3. **丰富的生态**: 大量官方和社区模块
4. **企业级特性**: 依赖注入、AOP、中间件等

### 为什么选择TypeORM？

1. **TypeScript支持**: 类型安全的ORM
2. **Active Record模式**: 简单易用
3. **迁移支持**: 数据库版本管理
4. **关系映射**: 强大的关系处理

### 为什么选择Redis？

1. **高性能**: 内存数据库，速度快
2. **丰富的数据结构**: String、Hash、List、Set等
3. **持久化支持**: RDB + AOF
4. **分布式支持**: 集群、哨兵模式

---

## 未来规划

### 短期（3个月）

- 完善测试覆盖率
- 性能优化实施
- 监控告警完善

### 中期（6个月）

- 微服务拆分
- 服务网格集成
- 分布式事务优化

### 长期（12个月）

- 云原生改造
- AI辅助开发
- 自动化运维

---

**最后更新**: 2024-12-19

